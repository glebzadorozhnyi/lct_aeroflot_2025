# Clf

## Install

Install uv: [guide](https://docs.astral.sh/uv/getting-started/installation/)

Install environment:

```bash
uv sync
```

## Annotate

Аннотацию делал SAM2.

Папки в датасете надо переименовать в соответствии с лейблами классов.

```bash
1_screw_flat
2_screw_plus
3_offset_screw_plus
4_kolovorot
5_safety_pliers
6_pliers
7_shernitsa
8_adjustable_wrench
9_can_opener
10_open_end_wrench_3_4
11_side_cutters
```

Таргеты классов, соответственно, `0-10`.

Notebook: [Annotate.ipynb](notebooks/Annotate.ipynb)

Annotations: `notebooks/annotations.csv`

## Run

Модель имеет один вход

- `"input", uint8, [bs, 112, 112, 3]`

Нужно по bbox вырезать найденный инструмент и сделать pad2square + resize(112).

И 2 выхода

- `"p", uint8, [bs, 11]` - вероятность каждого из 11 классов
- `"feature", uint8, [bs, 512]` - вектор

Модель обучалась на 2 задачи - классификация и метрик-лёрнинг (последнее как раз делает сравнение по расстоянию между векторами более качественным).

Также я пробовал выравнивать изображения, о чем можно подробнее посмотреть в ноутбуке [Aligning.ipynb](notebooks/Annotate.ipynb). Суть в том, чтобы фотографии всегда были повернуты в одном положении перед входом в модель, чтобы упростить модели жизнь, но практика показала, что и без этого хорошо работает. Но, возможно, на более обширных данных, это начнет вносить свой вклад.

Итого есть 2 режима работы:

- сразу получать предсказание класса `p`
- получить вектора `feature`, затем найти их similarity по формуле из ноутбука (ссылка ниже)

Model: `models/clf.onnx`

Notebook: [Run.ipynb](notebooks/Run.ipynb)

PS. Чтобы обучить хороший feature-extractor на задачу metric-learning, необходимо как можно больше разнообразных данных, причем уже должен быть не просто класс "отвертка", а "отвертка-1234" и "отвертка-2345", если мы хотим различать, что вернули именно ту отвертку, которую выдали. Ну и типов инструментов должно быть тоже много. Такая модель позволит в любой момент добавлять или удалять из базы новые типы инструментов.
